name: AGI_MIRE_CI_CD

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"
  POETRY_VERSION: "1.8.3"

jobs:
  setup:
    name: Preparar Ambiente
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache.outputs.cache-hit }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configurar Cache
        id: cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry
          key: poetry-cache-${{ hashFiles('**/poetry.lock') }}

      - name: Instalar Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Instalar Poetry
        run: pip install poetry==${{ env.POETRY_VERSION }}

      - name: Instalar Dependências
        run: poetry install --no-root


  lint:
    name: Lint & Static Analysis
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - uses: actions/checkout@v4

      - name: Instalar Ferramentas
        run: |
          pip install flake8 bandit safety

      - name: Executar Flake8
        run: flake8 .

      - name: Security Scan - Bandit
        run: bandit -r core -ll -iii

      - name: Security Scan - Safety
        run: safety check


  tests:
    name: Testes (Unitários + Integração + Stress)
    runs-on: ubuntu-latest
    needs: [setup, lint]

    steps:
      - uses: actions/checkout@v4

      - name: Instalar Dependências
        run: poetry install --no-root

      - name: Testes Unitários
        run: poetry run pytest -q tests/unit

      - name: Testes de Integração
        run: poetry run pytest -q tests/integration

      - name: Testes de Stress (SimLog V1.4, PRAG, RegVet)
        run: poetry run pytest -q tests/stress --maxfail=1

      - name: Relatório de Cobertura
        run: poetry run pytest --cov=core --cov-report=xml

      - name: Upload Coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: coverage.xml


  build:
    name: Build e Empacotamento
    runs-on: ubuntu-latest
    needs: tests

    steps:
      - uses: actions/checkout@v4

      - name: Build do Pacote
        run: poetry build

      - name: Upload Build
        uses: actions/upload-artifact@v4
        with:
          name: agi_mire_build
          path: dist/


  deploy_prod:
    name: Deploy em Produção
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'

    environment:
      name: production
      url: https://api.agi-mire.prod

    steps:
      - uses: actions/checkout@v4

      - name: Download Build
        uses: actions/download-artifact@v4
        with:
          name: agi_mire_build

      - name: Validar Versão e Assinatura
        run: |
          python scripts/verify_signature.py dist/*.whl
          python scripts/check_version_bump.py

      - name: Deploy Real
        run: |
          bash scripts/deploy_prod.sh dist/*.whl

      - name: Registrar Evento PRAG
        run: |
          curl -X POST "$CONTROLBUS_URL/emit" \
            -H "Content-Type: application/json" \
            -d '{"event":"DEPLOY_COMPLETED","metadata":{"version":"latest"}}'

      - name: Publicar Build
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*


  rollback:
    name: Rollback
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: Rollback Automático
        run: bash scripts/rollback.sh

      - name: Registrar Evento PRAG
        run: |
          curl -X POST "$CONTROLBUS_URL/emit" \
            -H "Content-Type: application/json" \
            -d '{"event":"DEPLOY_ROLLBACK"}'
